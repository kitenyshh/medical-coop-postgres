# Медицинский кооператив (PostgreSQL)

Веб‑приложение для работы врача медицинского кооператива: ведение пациентов, осмотров, диагнозов и лекарственных назначений. Версия реализована на PostgreSQL с использованием схемы‑пакета `coop_api` (функции, процедуры и триггеры).

## Стек технологий

- Backend: Node.js, Express  
- Шаблоны: EJS  
- База данных: PostgreSQL (схема `public` + схема `coop_api`)  
- Стили: CSS (адаптивная вёрстка, фиксированный header/footer)  

## Функциональность

- Регистрация и авторизация врача  
- Управление пациентами:
  - добавление и редактирование карточки пациента;
  - просмотр истории приёмов, диагнозов и назначенных лекарств.
- Осмотры:
  - учёт визитов на приёме и на дому;
  - выбор пациента и диагноза;
  - назначение существующего лекарства или добавление нового.
- Справочник диагнозов:
  - просмотр и добавление диагнозов.
- Отчётность (через функции `coop_api`):
  - вызовы по дате (количество визитов и врачи);
  - количество пациентов по диагнозу;
  - список лекарств с действием и побочными эффектами.

## Структура проекта

- `server.js` — основной сервер Express, маршруты и работа с PostgreSQL.  
- `schema_postgres.sql` — создание таблиц, связей и начальных данных.  
- `coop_package.sql` — схема `coop_api`, функции, процедуры и триггеры.  
- `views/` — EJS‑шаблоны (главная, вход, регистрация, осмотр, пациенты, карточка, диагнозы, отчётность).  
- `public/css/style.css` — оформление интерфейса.  
- `public/js/main.js` — заготовка под клиентский JS.

## Развёртывание

1. Установить PostgreSQL и создать базу:

```
CREATE DATABASE medical_coop ENCODING 'UTF8';
```

2. Выполнить в базе `medical_coop`:

```
\i schema_postgres.sql
\i coop_package.sql
```

3. Настроить подключение в `server.js`:

```
const pool = new Pool({
host: 'localhost',
port: 5433,
user: 'postgres',
password: 'ВАШ_ПАРОЛЬ',
database: 'medical_coop',
});
```

4. Установить зависимости и запустить сервер:

```
npm install
node server.js
```

5. Открыть в браузере:

- Главная: `http://localhost:3000/`  
- Вход: `http://localhost:3000/login`

Начальные пользователи и данные создаются скриптом `schema_postgres.sql`.

## Пакет `coop_api` (PostgreSQL)

Схема `coop_api` содержит:

- функции:
  - `get_visits_by_date(p_date date)` — отчёт по визитам за дату;
  - `get_patients_by_diagnosis()` — количество пациентов по каждому диагнозу;
  - `get_medicine_effects()` — сведения о лекарствах и побочных эффектах.
- процедуры:
  - `add_medicine(...)` — добавление нового лекарства;
  - `add_visit_with_prescription(...)` — визит с назначением существующего лекарства;
  - `add_visit_with_new_medicine(...)` — визит и одновременное создание нового лекарства.
- триггеры:
  - `trg_delete_patient_cascade` — каскадное удаление визитов и назначений пациента;
  - `trg_delete_medicine_cleanup` — очистка назначений при удалении лекарства.

Backend вызывает функции/процедуры через `SELECT` и `CALL` в маршрутах осмотра и отчётности.
